import pygame
from graphic_engine import GraphicEngine
from track import Track
import numpy as np
import robot
import robot_controller
import matplotlib.pyplot as plt
from time import time

pygame.init()

width, height = 1024, 768
screen = pygame.display.set_mode((width, height))
pygame.display.set_caption('Open Polygon')

ge = GraphicEngine(screen, 1024, 768)
ge.camera_FOV = 5
ge.camera_pos = [0, 2]

genotype = np.array([-1.51872583e+00,  6.82413738e-01,  1.66226765e+00,  7.83435558e-01,
        7.07585458e-01, -1.59803439e-01,  1.26583212e+00, -2.26058708e-01,
       -2.07678326e-01, -8.59634597e-01, -6.71730711e-01, -1.11299439e+00,
        2.26550443e-01,  4.50712120e-01,  2.58169166e-01,  4.17875016e-01,
       -3.16641129e-01,  1.18349169e+00,  2.62898852e-01,  2.17706225e+00,
       -4.56197402e-01,  9.24914924e-01,  4.17812650e-02, -9.56613724e-01,
       -4.10947626e-01, -1.37270781e+00, -2.03330829e+00,  1.29745525e+00,
        5.45975315e-01, -4.95533119e-01,  1.06784351e+00,  1.03555241e+00,
        7.46334382e-01, -6.91840783e-01, -7.54758329e-01,  2.83985842e-01,
       -8.54235260e-01,  8.33190521e-01, -1.75834568e+00,  2.77736907e+00,
        1.16101111e+00,  1.28922428e+00,  5.69924473e-01,  5.76652495e-01,
       -1.49116158e-01, -6.28653605e-02, -3.61392563e-01, -9.64817074e-01,
        1.31921753e+00,  9.15654513e-01, -4.39252297e-01, -1.20365497e+00,
       -2.50740145e-01,  1.09261062e+00, -1.16990842e-01,  2.55549276e-01,
       -8.61235398e-01,  1.49386916e+00,  6.74795224e-02, -2.85445106e-01,
        2.33230158e-01, -9.10431060e-01,  1.04634797e+00,  4.06312450e-01,
       -1.21630904e+00, -1.57706527e+00,  2.43963700e-04, -9.53175370e-01,
        1.33197417e-01,  2.58036773e-01, -3.64567883e-01,  1.10767157e+00,
        1.54887883e+00, -3.53034152e-01,  1.60829095e+00, -4.81526595e-01,
       -7.04459362e-02,  8.59329951e-01,  5.18774049e-02,  1.74357925e-01,
       -1.05808139e+00,  2.75844355e-01, -5.12075437e-01,  5.39853061e-01,
        4.61105207e-01, -6.95925191e-01, -2.58102276e-01, -1.24390401e-01,
       -1.45821363e+00, -3.10533959e-01,  2.13367329e+00,  1.31794317e+00,
       -1.58735984e-02, -6.75155698e-01,  3.09913727e-01,  8.45091647e-01,
        5.96191795e-01, -6.41768298e-01, -1.84624319e+00,  5.36623144e-02,
       -5.84558545e-02,  8.46057979e-02, -1.18128541e+00,  1.43918499e+00,
       -1.20034554e+00, -9.43038957e-01, -4.12650413e-01,  1.49117528e-01,
        8.01501477e-01,  3.11519898e-01,  2.33493303e-01, -4.43170560e-01,
       -1.24294912e+00, -2.30911069e+00,  4.93224552e-02,  9.85978529e-01,
        1.84453738e+00,  9.75098987e-01, -4.28106031e-01, -6.43268157e-01,
        1.21913998e+00,  7.12696618e-01, -6.34304406e-01, -1.72462716e+00,
        1.65881203e+00, -4.85870793e-01,  1.28734818e-01, -4.09839640e-01,
        7.40843398e-01, -3.13081274e-01, -7.62512838e-02,  8.95937798e-01,
        2.20565215e-01,  6.25729124e-01, -7.12598340e-02, -8.17075450e-01,
       -3.97926625e-01,  1.64417280e-01, -1.18789992e+00, -1.91324184e+00,
        1.13312494e+00,  4.44971444e-01, -4.19007432e-01,  3.90325256e-01,
       -9.35842902e-01, -8.64398706e-01, -1.05915143e+00,  4.23499729e-01,
       -6.94052897e-01, -1.16713048e+00, -1.15705006e+00, -1.41087503e+00,
        2.12983588e+00, -1.04426427e+00,  4.76135625e-01, -2.12270759e+00,
        6.89533694e-01, -2.22035078e-01,  9.77039668e-01, -4.22430219e-01,
        6.29770794e-01, -3.51101820e-01,  4.96358819e-01, -4.94458783e-02,
        9.66702843e-01, -2.60772103e-01, -4.13456838e-01,  8.40771325e-01,
        1.27901564e+00,  1.08402295e+00])


c = robot_controller.RobotController4(genotype[:170])

N=1
r = robot.Robot(
        max_motor_speed=1.0,
        wheelbase=[0.2],
        lenght=[0.14],
        engine_cutoff=0.05,
        rotation=np.pi/2,
        sensor_width=[0.067],
        sensor_n=8,
        sensor_noise=0.05,
        sensor_radius=0.005,
        min_speed=0.1,
        position=[0.0, 0.0],
        track_width=0.02
    )
t = Track(tile_size=0.25)
t.add_segment("straight")
for i in range(20):
    t.add_segment("")
t.add_segment("straight")
t.finalize(128)

clock = pygame.time.Clock()
running = True

dt = 1/200

while running:
    screen.fill((0, 0, 0))

    # Event handling
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    sensors = np.array(r.get_sensors(t)[0])
    inputs = np.array(sensors)
    e1, e2 = c.get_motors(inputs)
    # print(sensors)
    r.move([e1], [e2], dt)
    # print(np.round(sensors, 2))
    ge.draw_track(t)
    r.draw(ge)
    pygame.display.flip()
    clock.tick(60)


pygame.quit()

