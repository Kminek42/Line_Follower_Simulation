import pygame
from graphic_engine import GraphicEngine
from track import Track
import numpy as np
import robot
import robot_controller
import matplotlib.pyplot as plt
from time import time

pygame.init()

width, height = 1024, 768
screen = pygame.display.set_mode((width, height))
pygame.display.set_caption('Open Polygon')

ge = GraphicEngine(screen, 1024, 768)
ge.camera_FOV = 5
ge.camera_pos = [0, 2]

genotype = np.array([-7.20820129e-02,  1.77750509e+00,  4.45078027e-02, -1.05997576e+00,
        6.14957316e-01,  2.89134941e-01, -8.42100172e-01, -8.03372558e-02,
        4.05397784e-01,  1.62457165e-02,  1.25441407e+00,  1.39345706e+00,
        6.03231171e-01,  1.42240717e+00, -1.32992030e+00, -1.83019814e-01,
       -1.19357825e+00, -5.62761281e-01, -5.08764665e-01,  1.38505200e+00,
        5.65553405e-01, -1.92806678e-01,  9.49765465e-01,  1.45782308e+00,
       -6.94090104e-01, -2.18416028e-01, -9.71870666e-01, -2.22440360e+00,
        1.09537921e+00, -4.43961791e-01, -8.45225639e-03,  8.05109248e-01,
        1.63736656e-01, -3.18772432e-01, -1.97740530e+00, -1.81204449e+00,
       -8.04385858e-01, -1.23585782e-01, -1.21667966e+00, -2.31108647e-02,
       -5.93203888e-01, -1.07089699e+00,  8.89686693e-01, -8.30010384e-01,
       -1.05075796e+00,  1.49859165e-01, -1.51196086e+00, -8.80827742e-02,
       -2.30043543e-02,  4.66997343e-01, -5.23819195e-01,  9.98455757e-01,
        5.55151909e-01, -4.07886084e-01,  2.72143518e-01,  4.71196007e-01,
       -3.98103294e-01, -9.59215192e-01,  2.73287774e-02, -7.82454644e-02,
       -9.02575379e-02,  1.12703125e+00, -1.54308871e-03,  3.11116989e-01,
        1.34133931e+00, -2.62909424e-01, -5.08167853e-01, -1.05409058e+00,
        5.50554598e-01, -1.43213930e+00,  5.31404580e-01,  6.42484206e-01,
       -5.06187586e-01,  8.81943624e-01, -4.32991842e-01,  1.47099421e+00,
       -3.66261967e-01, -8.03848282e-01, -9.26831264e-01,  1.23880782e-01,
       -8.59511901e-01,  1.05032681e+00, -1.17648629e+00,  2.96662340e-01,
        9.53883193e-01,  2.03136441e-02,  1.49586653e+00, -3.13843684e-01,
       -9.35359559e-01, -6.47821827e-01, -1.34189798e+00, -3.98307119e-01,
       -1.86130765e+00,  2.48649801e-01, -3.50977398e-01,  1.69943135e+00,
        1.43177746e+00,  1.77483283e+00,  1.23182307e-01, -1.49782217e-01,
       -6.64842739e-01,  7.22637290e-01,  3.82532110e-01, -6.78107793e-01,
       -7.66930484e-01,  9.62996911e-01,  1.59006635e+00,  6.17231230e-01,
       -4.77816364e-01, -1.47960464e+00,  2.97069986e+00,  1.14863391e+00,
        2.06694350e+00,  4.21774870e-01,  3.28149843e-02,  6.87846436e-01,
        2.74862633e-02,  3.85877133e-01,  4.13921582e-01, -3.22942696e-01,
       -2.55058712e+00, -9.51992833e-02,  3.38608734e-01,  4.32436676e-01,
        6.82754933e-01, -5.40917527e-01,  1.01436087e+00,  9.93797273e-01,
       -6.32563793e-01,  4.85495484e-01,  1.31964665e+00,  1.51238621e+00,
        2.31651085e-02,  4.70363485e-01, -1.81772117e+00,  5.58141561e-01,
        7.55725222e-01,  4.78215073e-01,  7.05574827e-01,  3.03451971e-01,
       -4.89398377e-01, -8.67943863e-01,  1.52966514e+00,  3.16526318e-01,
       -1.32820345e-01, -6.56059452e-01,  2.46062255e-01,  4.52995797e-01,
        9.67853376e-02,  1.55646414e+00, -5.47489854e-02, -9.39353853e-01,
        3.35452925e-01, -1.48975161e+00, -7.39842407e-01,  1.03586292e+00,
        1.90034659e+00, -1.35093817e-02, -1.82445833e+00, -3.91154442e-01,
       -3.81521701e-01,  3.82404359e-01,  1.62308493e+00, -9.46075769e-01,
        1.87380465e+00, -1.02349412e+00,  2.80750234e-01,  4.02764006e-01,
       -7.13151969e-01, -2.07959933e-01, -1.07774805e+00, -8.12317592e-02,
        1.69629098e+00])


c = robot_controller.RobotController4(genotype[:170])

N=1
r = robot.Robot(
    max_motor_speed=1.0,
    wheelbase=[0.2 + 0.00 * genotype[170]],
    lenght=[0.14 + 0.00 * genotype[171]],
    engine_cutoff=0.1,
    rotation=np.pi/2,
    sensor_width=[0.067 + 0.00 * genotype[172]],
    sensor_n=8,
    sensor_noise=0.1,
    sensor_radius=0.005,
    min_speed=0.2,
    position=[0.0, 0.0],
    track_width=0.02
)
t = Track(tile_size=0.25)
t.add_segment("straight")
for i in range(20):
    t.add_segment("")
t.add_segment("straight")
t.finalize(128)

clock = pygame.time.Clock()
running = True

dt = 1/200

while running:
    screen.fill((0, 0, 0))

    # Event handling
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    sensors = np.array(r.get_sensors(t)[0])
    inputs = np.array(sensors)
    e1, e2 = c.get_motors(inputs)
    print(sensors)
    r.move([e1], [e2], dt)
    print(np.round(sensors, 2))
    ge.draw_track(t)
    r.draw(ge)
    pygame.display.flip()
    clock.tick(60)


pygame.quit()

