import pygame
from graphic_engine import GraphicEngine
from track import Track
import numpy as np
import robot
import robot_controller
import matplotlib.pyplot as plt
from time import time

pygame.init()

width, height = 1024, 768
screen = pygame.display.set_mode((width, height))
pygame.display.set_caption('Open Polygon')

ge = GraphicEngine(screen, 1024, 768)
ge.camera_FOV = 5
ge.camera_pos = [0, 2]

genotype = np.array([ 1.21686102,  0.13523254, -0.80073268,  1.25036739,  0.71657568,
        1.24623008,  0.6463195 ,  0.97691649,  0.06308021,  1.43025298,
        0.81754249,  1.00565011,  0.54721526,  0.53163787,  0.21016146,
        1.03981103, -0.52749032, -0.22598156, -0.28775663, -1.29587031,
       -1.35812203,  1.70722688,  0.20390729, -1.63003838, -1.21644124,
       -0.66357867, -0.7820251 , -0.83937513,  0.6778514 ,  0.10536748,
        1.24634356,  1.17416697,  0.85292596,  0.2506546 ,  0.07791147,
        0.99627783,  0.00961796,  0.20384155, -1.12809911, -0.00610975,
        0.45824076,  0.06262945, -1.23667741, -1.08136165, -1.05075796,
       -1.71865216,  1.54371643,  1.70081882, -0.69786471, -0.4551158 ,
       -1.08137592,  1.01329186,  1.26200769, -0.33511646, -0.475776  ,
       -0.58803114, -0.76438603, -0.3406083 ,  0.9601259 , -0.17689726,
       -0.08426898,  1.33304776, -0.03358369, -0.55822339, -2.44378268,
       -0.37067179,  0.5862336 ,  1.67308641,  1.98587731,  0.38633783,
       -0.25579069, -0.06594292,  0.13885026, -0.07913257,  0.83493755,
        0.08350342,  1.09064517,  0.77870259,  0.45797604,  1.76856197,
       -0.44627728, -0.1612349 , -0.19727696,  0.31813321, -0.22861279,
        1.78884772,  0.78641116,  0.0202943 , -0.70164224, -0.24839732,
       -0.25955648, -0.29925861, -1.9141994 ,  1.47186996, -1.37419394,
        1.13263962, -0.85095415, -0.02154119,  0.05854545, -2.98503805,
       -0.3768515 ,  1.27128311, -1.05364448, -0.38304521,  0.83719585,
       -0.13562699, -1.6976905 , -1.13744038,  0.39328642,  0.98510244,
        0.10157446, -0.35030432, -2.36026049,  0.95734159,  1.04117502,
       -0.23406013,  0.06564128,  0.47643506,  0.86029394,  0.94504003,
        0.1539818 ,  1.78891395, -0.10159236, -0.12214134, -1.38310449,
       -2.79952598, -0.00343027, -0.63793322, -1.21478387, -0.70774755,
        1.28873643, -0.08945937,  1.95842918, -1.00707668,  0.1847293 ,
        0.72924169,  1.3133818 ,  0.48184927, -0.78608069,  0.61183277,
        0.18670666, -0.42216676,  0.37254261,  1.7126854 ,  0.29700362,
       -1.30765628,  0.1122948 , -0.07409734,  1.96918767,  0.45345471,
        0.07707253,  0.61185668, -1.18591918,  0.92577922, -0.27832099,
       -0.5321204 ,  1.07960714,  0.52534151, -1.56439534,  0.13242945,
        0.64815194,  0.1819339 ,  1.22996112, -0.13226312,  0.08056842,
       -0.56464467,  0.61631086, -0.36315539,  0.14054048, -0.01790216,
       -0.18509629, -1.34157915,  1.38294233, -1.99301185,  1.25851287,
       -0.02578727, -1.62579924,  0.18035272,  0.50279288, -0.01416059,
        1.86377673,  0.18145888,  1.22039868, -0.56044957,  0.24454709,
        0.06653557,  2.0394153 , -1.2323124 ,  0.08775385,  1.18328275,
        0.05383676, -0.16139126, -2.03829804,  0.59722028,  0.11536395,
        0.07365435,  0.22301297, -0.30376533,  1.18386346, -0.21760361,
       -0.82502013,  0.05086041, -0.46027339, -0.93481343,  0.42242394,
        0.81072857,  1.56643827,  0.43960805,  0.58662329, -0.70805109,
        0.02386564, -0.68943243,  0.51793337,  1.20385162, -0.10708085,
        0.63088038,  0.42886521, -0.26303785, -0.417802  , -0.13919554,
       -0.57060604,  1.41449743,  0.77695937,  2.02428092,  0.53570273,
       -0.7483211 , -0.39028461,  0.49709839,  1.27603168, -0.09100844,
       -1.28346522,  0.24925054,  1.21965073, -0.66249716, -0.42851895,
        0.62752009, -0.74310208,  1.26062118, -1.21044015,  0.36755118,
       -1.89916811, -0.56010237,  1.90932522,  0.52088191, -2.06019781,
        0.75959565, -1.34523598, -0.03967529,  0.51869267,  0.35002573,
       -0.19692692, -1.84931067,  1.03599857, -2.0250863 , -1.92463749,
       -0.58402032,  0.88763768,  0.1502691 ,  0.78847387,  0.70047194,
       -1.03534962,  0.91682389,  0.63257697, -0.28856812, -0.60575979,
       -0.92956752,  1.42859338, -0.3164847 ,  0.4545129 , -1.36199328,
       -0.90989994,  0.63446386,  0.02802625,  0.22466394, -1.00467456])


c = robot_controller.RobotController5(genotype[:272])

N=1
r = robot.Robot(
    max_motor_speed=1.0,
    wheelbase=[0.2 + 0.05 * genotype[272]],
    lenght=[0.14 + 0.05 * genotype[273]],
    engine_cutoff=0.1,
    rotation=np.pi/2,
    sensor_width=[0.067 + 0.01 * genotype[274]],
    sensor_n=8,
    sensor_noise=0.1,
    sensor_radius=0.005,
    min_speed=0.1,
    position=[0.0, 0.0],
    track_width=0.018
)
t = Track(tile_size=0.25)
t.add_segment("straight")
for i in range(20):
    t.add_segment("")
t.add_segment("straight")
t.finalize(128)

clock = pygame.time.Clock()
running = True

dt = 1/200

while running:
    screen.fill((0, 0, 0))

    # Event handling
    for event in pygame.event.get():
        if event.type == pygame.QUIT:
            running = False

    sensors = np.array(r.get_sensors(t)[0])
    inputs = np.array(sensors)
    e1, e2 = c.get_motors(inputs)
    print(sensors)
    r.move([e1], [e2], dt)
    print(np.round(sensors, 2))
    ge.draw_track(t)
    r.draw(ge)
    pygame.display.flip()
    clock.tick(60)


pygame.quit()

